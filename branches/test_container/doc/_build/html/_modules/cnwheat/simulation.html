<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cnwheat.simulation &mdash; CN-Wheat 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CN-Wheat 0.0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CN-Wheat 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cnwheat.simulation</h1><div class="highlight"><pre>
<span class="c"># -*- coding: latin-1 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span> <span class="c"># use &quot;//&quot; to do integer division</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    cnwheat.simulation</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    The module :mod:`cnwheat.simulation` is the front-end to run the CN-Wheat model.</span>

<span class="sd">    :copyright: Copyright 2014-2015 INRA-ECOSYS, see AUTHORS.</span>
<span class="sd">    :license: TODO, see LICENSE for details.</span>

<span class="sd">    .. seealso:: Barillot et al. 2015.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information about this versioned file:</span>
<span class="sd">        $LastChangedBy: rbarillot $</span>
<span class="sd">        $LastChangedDate: 2016-06-22 11:15:45 +0200 (mer., 22 juin 2016) $</span>
<span class="sd">        $LastChangedRevision: 217 $</span>
<span class="sd">        $URL: https://subversion.renater.fr/cn-wheat/trunk/cnwheat/simulation.py $</span>
<span class="sd">        $Id: simulation.py 217 2016-06-22 09:15:45Z rbarillot $</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span>
<span class="kn">from</span> <span class="nn">respiwheat.model</span> <span class="kn">import</span> <span class="n">RespirationModel</span>

<span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">tools</span>

<div class="viewcode-block" id="SimulationError"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.SimulationError">[docs]</a><span class="k">class</span> <span class="nc">SimulationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="SimulationRunError"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.SimulationRunError">[docs]</a><span class="k">class</span> <span class="nc">SimulationRunError</span><span class="p">(</span><span class="n">SimulationError</span><span class="p">):</span> <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Simulation class permits to initialize and run the model.</span>

<span class="sd">    Use :meth:`run` to run the model.</span>

<span class="sd">    :Parameters:</span>

<span class="sd">        - `population` (:class:`list`) - the :class:`population &lt;cnwheat.model.Population` in the system.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: the name of the compartments attributes in the model.</span>
    <span class="n">MODEL_COMPARTMENTS_NAMES</span> <span class="o">=</span> <span class="p">{</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">:</span> <span class="p">[],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;amino_acids&#39;</span><span class="p">,</span> <span class="s">&#39;nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;structure&#39;</span><span class="p">,</span> <span class="s">&#39;starch&#39;</span><span class="p">,</span> <span class="s">&#39;proteins&#39;</span><span class="p">,</span> <span class="s">&#39;mstruct&#39;</span><span class="p">,</span> <span class="s">&#39;Nstruct&#39;</span><span class="p">,</span> <span class="s">&#39;cytokinins&#39;</span><span class="p">],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;fructan&#39;</span><span class="p">,</span> <span class="s">&#39;mstruct&#39;</span><span class="p">,</span> <span class="s">&#39;amino_acids&#39;</span><span class="p">,</span> <span class="s">&#39;proteins&#39;</span><span class="p">],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;starch&#39;</span><span class="p">,</span> <span class="s">&#39;amino_acids&#39;</span><span class="p">,</span> <span class="s">&#39;proteins&#39;</span><span class="p">,</span>
                                                                   <span class="s">&#39;sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;triosesP&#39;</span><span class="p">,</span> <span class="s">&#39;fructan&#39;</span><span class="p">,</span> <span class="s">&#39;cytokinins&#39;</span><span class="p">],</span>
                                <span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">]}</span>

    <span class="n">T_INDEX</span> <span class="o">=</span> <span class="s">&#39;t&#39;</span>

    <span class="n">PLANTS_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span>
    <span class="n">PLANTS_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">PLANTS_INPUTS_INDEXES</span>
    <span class="n">PLANTS_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PLANTS_STATE</span> <span class="o">=</span> <span class="n">PLANTS_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">PLANTS_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PLANTS_FLUXES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PLANTS_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PLANTS_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">PLANTS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">PLANTS_STATE</span> <span class="o">+</span> <span class="n">PLANTS_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">PLANTS_FLUXES</span> <span class="o">+</span> <span class="n">PLANTS_INTEGRATIVE_VARIABLES</span>
    <span class="n">PLANTS_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PLANTS_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">PLANTS_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">PLANTS_POSTPROCESSING_VARIABLES</span>

    <span class="n">AXES_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">]</span>
    <span class="n">AXES_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">AXES_INPUTS_INDEXES</span>
    <span class="n">AXES_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">AXES_STATE</span> <span class="o">=</span> <span class="n">AXES_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">AXES_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">AXES_FLUXES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">AXES_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Total_transpiration&#39;</span><span class="p">]</span>
    <span class="n">AXES_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">AXES_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">AXES_STATE</span> <span class="o">+</span> <span class="n">AXES_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">AXES_FLUXES</span> <span class="o">+</span> <span class="n">AXES_INTEGRATIVE_VARIABLES</span>
    <span class="n">AXES_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">AXES_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">AXES_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">AXES_POSTPROCESSING_VARIABLES</span>

    <span class="n">PHYTOMERS_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]</span>
    <span class="n">PHYTOMERS_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">PHYTOMERS_INPUTS_INDEXES</span>
    <span class="n">PHYTOMERS_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PHYTOMERS_STATE</span> <span class="o">=</span> <span class="n">PHYTOMERS_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">PHYTOMERS_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PHYTOMERS_FLUXES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PHYTOMERS_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PHYTOMERS_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">PHYTOMERS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">PHYTOMERS_STATE</span> <span class="o">+</span> <span class="n">PHYTOMERS_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">PHYTOMERS_FLUXES</span> <span class="o">+</span> <span class="n">PHYTOMERS_INTEGRATIVE_VARIABLES</span>
    <span class="n">PHYTOMERS_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">PHYTOMERS_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">PHYTOMERS_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">PHYTOMERS_POSTPROCESSING_VARIABLES</span>

    <span class="n">ORGANS_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">,</span> <span class="s">&#39;organ&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">ORGANS_INPUTS_INDEXES</span>
    <span class="n">ORGANS_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mstruct_C_growth&#39;</span><span class="p">,</span> <span class="s">&#39;Nstruct_N_growth&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_STATE</span> <span class="o">=</span> <span class="n">ORGANS_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">ORGANS_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;RGR_Structure&#39;</span><span class="p">,</span> <span class="s">&#39;R_Nnit_upt&#39;</span><span class="p">,</span> <span class="s">&#39;R_Nnit_red&#39;</span><span class="p">,</span> <span class="s">&#39;R_residual&#39;</span><span class="p">,</span> <span class="s">&#39;R_maintenance&#39;</span><span class="p">,</span> <span class="s">&#39;R_grain_growth_struct&#39;</span><span class="p">,</span> <span class="s">&#39;R_grain_growth_starch&#39;</span><span class="p">,</span> <span class="s">&#39;R_growth&#39;</span><span class="p">,</span>
                                     <span class="s">&#39;C_exudation&#39;</span><span class="p">,</span> <span class="s">&#39;N_exudation&#39;</span><span class="p">,</span> <span class="s">&#39;regul_transpiration&#39;</span><span class="p">,</span> <span class="s">&#39;HATS_LATS&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_FLUXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Unloading_Sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;Export_Nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;Export_Amino_Acids&#39;</span><span class="p">,</span> <span class="s">&#39;S_Proteins&#39;</span><span class="p">,</span> <span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">,</span> <span class="s">&#39;Unloading_Amino_Acids&#39;</span><span class="p">,</span>
                     <span class="s">&#39;S_grain_starch&#39;</span><span class="p">,</span> <span class="s">&#39;Uptake_Nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;S_grain_structure&#39;</span><span class="p">,</span> <span class="s">&#39;S_cytokinins&#39;</span><span class="p">,</span> <span class="s">&#39;Export_cytokinins&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;total_organic_nitrogen&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">ORGANS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">ORGANS_STATE</span> <span class="o">+</span> <span class="n">ORGANS_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">ORGANS_FLUXES</span> <span class="o">+</span> <span class="n">ORGANS_INTEGRATIVE_VARIABLES</span>
    <span class="n">ORGANS_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Conc_Nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Amino_Acids&#39;</span><span class="p">,</span> <span class="s">&#39;Dry_Mass&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;Proteins_N_Mass&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_cytokinins&#39;</span><span class="p">]</span>
    <span class="n">ORGANS_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">ORGANS_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">ORGANS_POSTPROCESSING_VARIABLES</span>

    <span class="n">HIDDENGROWINGZONE_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]</span>
    <span class="n">HIDDENGROWINGZONE_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_INPUTS_INDEXES</span>
    <span class="n">HIDDENGROWINGZONE_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HIDDENGROWINGZONE_STATE</span> <span class="o">=</span> <span class="n">HIDDENGROWINGZONE_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">HIDDENGROWINGZONE_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HIDDENGROWINGZONE_FLUXES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HIDDENGROWINGZONE_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HIDDENGROWINGZONE_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">HIDDENGROWINGZONE_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_STATE</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_FLUXES</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_INTEGRATIVE_VARIABLES</span>
    <span class="n">HIDDENGROWINGZONE_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HIDDENGROWINGZONE_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">HIDDENGROWINGZONE_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">HIDDENGROWINGZONE_POSTPROCESSING_VARIABLES</span>

    <span class="n">ELEMENTS_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">,</span> <span class="s">&#39;organ&#39;</span><span class="p">,</span> <span class="s">&#39;element&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">ELEMENTS_INPUTS_INDEXES</span>
    <span class="n">ELEMENTS_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mstruct&#39;</span><span class="p">,</span> <span class="s">&#39;Nstruct&#39;</span><span class="p">,</span> <span class="s">&#39;green_area&#39;</span><span class="p">,</span> <span class="s">&#39;Ag&#39;</span><span class="p">,</span> <span class="s">&#39;Tr&#39;</span><span class="p">,</span> <span class="s">&#39;Ts&#39;</span><span class="p">,</span> <span class="s">&#39;is_growing&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_STATE</span> <span class="o">=</span> <span class="n">ELEMENTS_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">ELEMENTS_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Transpiration&#39;</span><span class="p">,</span> <span class="s">&#39;R_phloem_loading&#39;</span><span class="p">,</span> <span class="s">&#39;R_Nnit_red&#39;</span><span class="p">,</span> <span class="s">&#39;R_residual&#39;</span><span class="p">,</span> <span class="s">&#39;R_maintenance&#39;</span><span class="p">,</span> <span class="s">&#39;Photosynthesis&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_FLUXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Loading_Sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;Regul_S_Fructan&#39;</span><span class="p">,</span> <span class="s">&#39;S_Starch&#39;</span><span class="p">,</span> <span class="s">&#39;D_Starch&#39;</span><span class="p">,</span> <span class="s">&#39;S_Sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;S_Fructan&#39;</span><span class="p">,</span> <span class="s">&#39;D_Fructan&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;total_organic_nitrogen&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">ELEMENTS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">ELEMENTS_STATE</span> <span class="o">+</span> <span class="n">ELEMENTS_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">ELEMENTS_FLUXES</span> <span class="o">+</span> <span class="n">ELEMENTS_INTEGRATIVE_VARIABLES</span>
    <span class="n">ELEMENTS_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Conc_TriosesP&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Starch&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Sucrose&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Fructan&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Nitrates&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Amino_Acids&#39;</span><span class="p">,</span> <span class="s">&#39;Conc_Proteins&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;Nitrates_import&#39;</span><span class="p">,</span> <span class="s">&#39;Amino_Acids_import&#39;</span><span class="p">,</span> <span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">,</span> <span class="s">&#39;S_Proteins&#39;</span><span class="p">,</span> <span class="s">&#39;D_Proteins&#39;</span><span class="p">,</span> <span class="s">&#39;Loading_Amino_Acids&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;Conc_cytokinins&#39;</span><span class="p">,</span> <span class="s">&#39;D_cytokinins&#39;</span><span class="p">,</span> <span class="s">&#39;cytokinins_import&#39;</span><span class="p">,</span> <span class="s">&#39;k_proteins&#39;</span><span class="p">]</span>
    <span class="n">ELEMENTS_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">ELEMENTS_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">ELEMENTS_POSTPROCESSING_VARIABLES</span>

    <span class="n">SOILS_INPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;axis&#39;</span><span class="p">]</span>
    <span class="n">SOILS_OUTPUTS_INDEXES</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_INDEX</span><span class="p">]</span> <span class="o">+</span> <span class="n">SOILS_INPUTS_INDEXES</span>
    <span class="n">SOILS_STATE_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">,</span> <span class="s">&#39;Tsoil&#39;</span><span class="p">]</span>
    <span class="n">SOILS_STATE</span> <span class="o">=</span> <span class="n">SOILS_STATE_PARAMETERS</span> <span class="o">+</span> <span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">SOILS_INTERMEDIATE_VARIABLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Conc_Nitrates_Soil&#39;</span><span class="p">]</span>
    <span class="n">SOILS_FLUXES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">SOILS_INTEGRATIVE_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">SOILS_RUN_VARIABLES</span> <span class="o">=</span> <span class="n">SOILS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">SOILS_STATE</span> <span class="o">+</span> <span class="n">SOILS_INTERMEDIATE_VARIABLES</span> <span class="o">+</span> <span class="n">SOILS_FLUXES</span> <span class="o">+</span> <span class="n">SOILS_INTEGRATIVE_VARIABLES</span>
    <span class="n">SOILS_POSTPROCESSING_VARIABLES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">SOILS_ALL_VARIABLES</span> <span class="o">=</span> <span class="n">SOILS_RUN_VARIABLES</span> <span class="o">+</span> <span class="n">SOILS_POSTPROCESSING_VARIABLES</span>

    <span class="n">LOGGERS_NAMES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;compartments&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.plants&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.axes&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.phytomers&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.organs&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span><span class="p">:</span> <span class="s">&#39;growthwheat.compartments.HiddenGrowingZone&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.elements&#39;</span><span class="p">,</span>
                                      <span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">:</span> <span class="s">&#39;cnwheat.compartments.soils&#39;</span><span class="p">},</span>
                     <span class="s">&#39;derivatives&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.plants&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.axes&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.phytomers&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.organs&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span><span class="p">:</span> <span class="s">&#39;growthwheat.derivatives.HiddenGrowingZone&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.elements&#39;</span><span class="p">,</span>
                                     <span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">:</span> <span class="s">&#39;cnwheat.derivatives.soils&#39;</span><span class="p">}}</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta_t</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Population</span><span class="p">()</span> <span class="c">#: the population to simulate on</span>

        <span class="c">#: The inputs of the soils.</span>
        <span class="c">#:</span>
        <span class="c">#: `soils` is a dictionary of objects of type :class:`model.Soil`:</span>
        <span class="c">#:     {(plant_index, axis_label): soil_object, ...}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soils</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">[]</span> <span class="c">#: the initial conditions of the compartments in the population and the soils</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#: dictionary to map the compartments to their indexes in :attr:`initial_conditions`</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c">#: the time grid of the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span> <span class="c">#: the value of the compartments for each time step, with the initial conditions in the first row</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Solver progress&#39;</span><span class="p">)</span> <span class="c">#: progress bar to show the progress of the solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progressbar</span> <span class="o">=</span> <span class="bp">False</span> <span class="c">#: True: show the progress bar ; False: DO NOT show the progress bar</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="n">delta_t</span> <span class="c">#: the delta t of the simulation (in seconds)</span>


<div class="viewcode-block" id="Simulation.initialize"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.Simulation.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">soils</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize:</span>

<span class="sd">            * :attr:`population`,</span>
<span class="sd">            * :attr:`soils`,</span>
<span class="sd">            * :attr:`initial_conditions_mapping`,</span>
<span class="sd">            * and :attr:`initial_conditions`</span>

<span class="sd">        from `population` and `soils`.</span>

<span class="sd">        :Parameters:</span>

<span class="sd">            - `population` (:class:`model.Population`) - a population of plants.</span>

<span class="sd">            - `soils` (:class:`dict`) - the soils of each axis.</span>
<span class="sd">              `soils` must be a dictionary with the same structure as :attr:`soils`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Initialization of the simulation...&#39;</span><span class="p">)</span>

        <span class="c"># clean the attributes of the simulation</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soils</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">soils</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">soils</span><span class="p">)</span>

        <span class="c"># initialize initial conditions</span>
        <span class="k">def</span> <span class="nf">_init_initial_conditions</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="n">model_object</span><span class="o">.</span><span class="n">__class__</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span><span class="p">):</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">HiddenGrowingZone</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">):</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Organ</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">):</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span>
            <span class="n">compartments_names</span> <span class="o">=</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">class_</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">model_object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">compartment_name</span> <span class="ow">in</span> <span class="n">compartments_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">model_object</span><span class="p">][</span><span class="n">compartment_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">i</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">soil</span> <span class="ow">in</span> <span class="n">soils</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">plant</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">plant</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">organ</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">phytomer</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">organ</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">:</span> <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">_init_initial_conditions</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c">#TODO: check the consistency of population and soils</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Initialization of the simulation DONE&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Simulation.run"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.Simulation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">,</span> <span class="n">number_of_output_steps</span><span class="p">,</span> <span class="n">odeint_mxstep</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_progressbar</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute CN exchanges in :attr:`population` and :attr:`soils` from `start_time` to `stop_time`, for `number_of_output_steps` steps.</span>

<span class="sd">        :Parameters:</span>

<span class="sd">            - `start_time` (:class:`int`) - The starting of the time grid (in seconds).</span>

<span class="sd">            - `stop_time` (:class:`int`) - The end of the time grid (in seconds).</span>

<span class="sd">            - `number_of_output_steps` (:class:`int`) - Number of time points for which to compute the CN exchanges in :attr:`population`.</span>

<span class="sd">            - `odeint_mxstep` (:class:`int`) - Maximum number of (internally defined) steps allowed for each integration point in time grid.</span>
<span class="sd">              `odeint_mxstep` is passed to :func:`scipy.integrate.odeint` as `mxstep`. If `odeint_mxstep` = 0 (the default), then `mxstep` is determined by the solver.</span>
<span class="sd">              Normally, the `mxstep` determined by the solver permits to solve the current model. User can try to increase this value if a more complex model is defined</span>
<span class="sd">              and if the integration failed. However, take care that the origin of an integration failure could be a discontinuity in the RHS function used</span>
<span class="sd">              by :func:`scipy.integrate.odeint`, and that this discontinuity could be due to a bug in your model. To summary: if the integration failed, first</span>
<span class="sd">              check the logs.</span>

<span class="sd">            - `show_progressbar` (:class:`bool`) - True: show the progress bar ; False: do not show the progress bar.</span>

<span class="sd">        :Returns:</span>
<span class="sd">            Dictionary containing output information from the solver.</span>
<span class="sd">            This is the dictionary returned by :func:`scipy.integrate.odeint` as second output.</span>
<span class="sd">            See the documentation of :func:`scipy.integrate.odeint` for more information.</span>

<span class="sd">        :Returns Type:</span>
<span class="sd">            :class:`dict`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Run of CN-Wheat from {} to {}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">))</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">,</span> <span class="n">number_of_output_steps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_progressbar</span> <span class="o">=</span> <span class="n">show_progressbar</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progressbar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">set_t_max</span><span class="p">(</span><span class="n">stop_time</span><span class="p">)</span>

        <span class="n">compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments&#39;</span><span class="p">)</span>
        <span class="n">derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compartments_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="ow">or</span> <span class="n">derivatives_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span>
            <span class="k">if</span> <span class="n">compartments_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="n">plants_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.plants&#39;</span><span class="p">)</span>
                <span class="n">plants_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PLANTS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">]))</span>
                <span class="n">axes_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.axes&#39;</span><span class="p">)</span>
                <span class="n">axes_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">AXES_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">]))</span>
                <span class="n">phytomers_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.phytomers&#39;</span><span class="p">)</span>
                <span class="n">phytomers_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PHYTOMERS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">]))</span>
                <span class="n">organs_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.organs&#39;</span><span class="p">)</span>
                <span class="n">organs_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ORGANS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">]))</span>
                <span class="n">elements_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.elements&#39;</span><span class="p">)</span>
                <span class="n">elements_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ELEMENTS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">]))</span>
                <span class="n">soils_compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments.soils&#39;</span><span class="p">)</span>
                <span class="n">soils_compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">SOILS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">derivatives_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                <span class="n">plants_derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives.plants&#39;</span><span class="p">)</span>
                <span class="n">plants_derivatives_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PLANTS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">]))</span>
                <span class="n">axes_derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives.axes&#39;</span><span class="p">)</span>
                <span class="n">axes_derivatives_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">AXES_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">]))</span>
                <span class="n">phytomers_derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives.phytomers&#39;</span><span class="p">)</span>
                <span class="n">phytomers_derivatives_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PHYTOMERS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">]))</span>
                <span class="n">organs_derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives.organs&#39;</span><span class="p">)</span>
                <span class="n">organs_derivatives_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ORGANS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">]))</span>
                <span class="n">soils_derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives.soils&#39;</span><span class="p">)</span>
                <span class="n">soils_derivatives_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">SOILS_OUTPUTS_INDEXES</span> <span class="o">+</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_initial_conditions</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;Run the solver with:</span>
<span class="sd">                    - time grid = %s,</span>
<span class="sd">                    - odeint mxstep = %s&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">odeint_mxstep</span><span class="p">)</span>

        <span class="n">soln</span><span class="p">,</span> <span class="n">infodict</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calculate_all_derivatives</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mxstep</span><span class="o">=</span><span class="n">odeint_mxstep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;Run of the solver DONE: infodict = %s&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">infodict</span><span class="p">)</span>

        <span class="c"># update self._time_grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c"># update self._solver_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_solver_output</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">soln</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">copyto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_solver_output</span><span class="p">,</span> <span class="n">soln</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">infodict</span><span class="p">[</span><span class="s">&#39;mused&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Integration failed. See the logs of lsoda or try to increase the value of &#39;mxstep&#39;.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SimulationRunError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">last_compartments_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_model</span><span class="p">(</span><span class="n">last_compartments_values</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">calculate_integrative_variables</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Run of CN-Wheat from {} to {} DONE&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">infodict</span>

</div>
    <span class="k">def</span> <span class="nf">_update_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the compartments values in :attr:`initial_conditions` from the compartments values of :attr:`population` and :attr:`soils`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model_object</span><span class="p">,</span> <span class="n">compartments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="n">compartment_index</span> <span class="ow">in</span> <span class="n">compartments</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">[</span><span class="n">compartment_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">loggers_names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log the values in `y` to the loggers in `loggers_names`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">update_rows</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">class_</span> <span class="o">=</span> <span class="n">model_object</span><span class="o">.</span><span class="n">__class__</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">):</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Organ</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">):</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span>
            <span class="n">compartments_names</span> <span class="o">=</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">MODEL_COMPARTMENTS_NAMES</span><span class="p">[</span><span class="n">class_</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">compartment_name</span> <span class="ow">in</span> <span class="n">compartments_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">):</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;NA&#39;</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">all_rows</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">class_</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="n">loggers_names</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">soil_id</span><span class="p">,</span> <span class="n">soil</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">soils</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span> <span class="n">soil_id</span><span class="p">,</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Soil</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">plant</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Plant</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">plant</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">],</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Axis</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">organ</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s">&#39;NA&#39;</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">label</span><span class="p">],</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Organ</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">phytomer</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">Phytomer</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">update_rows</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">label</span><span class="p">],</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">PhotosyntheticOrganElement</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">row_sep</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">column_sep</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span>
        <span class="k">for</span> <span class="n">class_</span><span class="p">,</span> <span class="n">logger_name</span> <span class="ow">in</span> <span class="n">loggers_names</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
            <span class="n">formatted_initial_conditions</span> <span class="o">=</span> <span class="n">row_sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">column_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">class_</span><span class="p">]])</span>
            <span class="n">compartments_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">formatted_initial_conditions</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_calculate_all_derivatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the derivative of `y` at `t`.</span>

<span class="sd">        :meth:`_calculate_all_derivatives` is passed as **func** argument to</span>
<span class="sd">        :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`.</span>
<span class="sd">        :meth:`_calculate_all_derivatives` is called automatically by</span>
<span class="sd">        :func:`scipy.integrate.odeint &lt;scipy.integrate.odeint&gt;`.</span>

<span class="sd">        First call to :meth:`_calculate_all_derivatives` uses `y` = **y0** and</span>
<span class="sd">        `t` = **t** [0], where **y0** and **t** are arguments passed to :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`.</span>

<span class="sd">        Following calls to :meth:`_calculate_all_derivatives` use `t` in [min( **t** ), max( **t** ) + 1] where</span>
<span class="sd">        **t** is an argument passed to :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`. `y` is</span>
<span class="sd">        computed automatically by the solver.</span>

<span class="sd">        :Parameters:</span>

<span class="sd">            - `y` (:class:`list`) - The current y values. `y` is automatically set by</span>
<span class="sd">              :func:`scipy.integrate.odeint`. User does not have control over `y`.</span>
<span class="sd">              At first call to :meth:`_calculate_all_derivatives` by :func:`scipy.integrate.odeint`, `y` = **y0**</span>
<span class="sd">              where **y0** is one of the arguments passed to :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`.</span>
<span class="sd">              For each following call to :meth:`_calculate_all_derivatives`, `y` is</span>
<span class="sd">              computed automatically by the solver.</span>

<span class="sd">            - `t` (:class:`float`) - The current t at which we want to compute the derivatives.</span>
<span class="sd">              `t` is automatically set by :func:`scipy.integrate.odeint`.</span>
<span class="sd">              User does not have control over `t`.</span>
<span class="sd">              At first call to :meth:`_calculate_all_derivatives` :func:`scipy.integrate.odeint`,</span>
<span class="sd">              `t` = **t** [0], where **t** is one of the arguments passed to :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`.</span>
<span class="sd">              For each following call to :meth:`_calculate_all_derivatives`, `t` belongs</span>
<span class="sd">              to the interval [min( **t** ), max( **t** ) + 1], where **t** is an</span>
<span class="sd">              argument passed to :func:`odeint(func, y0, t, args=(),...) &lt;scipy.integrate.odeint&gt;`.</span>

<span class="sd">        :Returns:</span>
<span class="sd">            The derivatives of `y` at `t`.</span>

<span class="sd">        :Returns Type:</span>
<span class="sd">            :class:`list`</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;t = {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

        <span class="n">compartments_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.compartments&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compartments_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_compartments</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">LOGGERS_NAMES</span><span class="p">[</span><span class="s">&#39;compartments&#39;</span><span class="p">])</span>

        <span class="c"># check that the solver is not crashed</span>
        <span class="n">y_isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_isnan</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;The solver did not manage to compute a compartment. See the logs. NaN found in y&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SimulationRunError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">y_derivatives</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">plant</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
                <span class="c"># Phloem</span>
                <span class="n">phloem_contributors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                <span class="c"># Roots</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">nitrates</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">amino_acids</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">cytokinins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span>
                <span class="n">phloem_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">)</span>

                <span class="n">soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soils</span><span class="p">[(</span><span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">)]</span>
                <span class="n">soil</span><span class="o">.</span><span class="n">nitrates</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">soil</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>

                <span class="c"># compute total transpiration at t_inf</span>
                <span class="n">total_transpiration</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># mmol s-1</span>
                <span class="n">total_green_area</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># m2</span>
                <span class="n">transpiration_mapping</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_total_transpiration</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">Tr</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span><span class="p">)</span>
                                    <span class="n">total_transpiration</span> <span class="o">+=</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
                                    <span class="n">total_green_area</span> <span class="o">+=</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span>

                <span class="k">if</span> <span class="n">total_green_area</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">total_surfacic_transpiration</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_surfacic_transpiration</span> <span class="o">=</span> <span class="n">total_transpiration</span><span class="o">/</span><span class="n">total_green_area</span> <span class="c">#: total transpiration rate of plant per unit area (mmol m-2 s-1)</span>

                <span class="c"># Compute the regulating factor of root exports by shoot transpiration</span>
                <span class="n">regul_transpiration</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_regul_transpiration</span><span class="p">(</span><span class="n">total_surfacic_transpiration</span><span class="p">)</span>

                <span class="c"># compute the flows from/to the roots to/from photosynthetic organs</span>
                <span class="n">conc_nitrates_soil</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">calculate_conc_nitrates</span><span class="p">(</span><span class="n">soil</span><span class="o">.</span><span class="n">nitrates</span><span class="p">)</span>
                <span class="n">roots_uptake_nitrate</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_uptake_nitrates</span><span class="p">(</span><span class="n">conc_nitrates_soil</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">nitrates</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">R_Nnit_upt</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_upt</span><span class="p">(</span><span class="n">roots_uptake_nitrate</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">)</span>
                <span class="n">roots_export_nitrates</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_nitrates</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">nitrates</span><span class="p">,</span> <span class="n">regul_transpiration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">roots_export_amino_acids</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_amino_acids</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">regul_transpiration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">roots_export_cytokinins</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_cytokinins</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">cytokinins</span><span class="p">,</span> <span class="n">regul_transpiration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                <span class="c"># compute the derivative of each photosynthetic organ element compartment</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="c"># Hidden growing zone</span>
                    <span class="n">hgz</span> <span class="o">=</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span>
                    <span class="k">if</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">sucrose</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">fructan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">mstruct</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;mstruct&#39;</span><span class="p">]]</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">amino_acids</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">proteins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>
                        <span class="n">phloem_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hgz</span><span class="p">)</span>

                        <span class="c"># Unloading of sucrose from phloem</span>
                        <span class="n">conc_sucrose_hidden_growing_zone</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_conc_sucrose</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">hgz</span><span class="o">.</span><span class="n">mstruct</span><span class="p">)</span>
                        <span class="n">conc_sucrose_phloem</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_conc_sucrose</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">)</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">unloading_sucrose</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_unloading_sucrose</span><span class="p">(</span><span class="n">conc_sucrose_hidden_growing_zone</span><span class="p">,</span> <span class="n">conc_sucrose_phloem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                        <span class="c"># Unloading of AA from phloem</span>
                        <span class="n">conc_amino_acids_hidden_growing_zone</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_conc_amino_acids</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">hgz</span><span class="o">.</span><span class="n">mstruct</span><span class="p">)</span>
                        <span class="n">conc_amino_acids_phloem</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_conc_amino_acids</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)</span>
                        <span class="n">hgz</span><span class="o">.</span><span class="n">unloading_amino_acids</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_unloading_amino_acids</span><span class="p">(</span><span class="n">conc_amino_acids_hidden_growing_zone</span><span class="p">,</span> <span class="n">conc_amino_acids_phloem</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                        <span class="c"># Fructan synthesis</span>
                        <span class="n">Regul_Sfructanes</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">Regul_Sfructanes</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">unloading_sucrose</span><span class="p">)</span>
                        <span class="n">s_fructan</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_s_fructan</span><span class="p">(</span><span class="n">conc_sucrose_hidden_growing_zone</span><span class="p">,</span> <span class="n">Regul_Sfructanes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                        <span class="c"># Fructan degradation</span>
                        <span class="n">conc_fructan</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_conc_fructan</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">fructan</span><span class="p">,</span> <span class="n">hgz</span><span class="o">.</span><span class="n">mstruct</span><span class="p">)</span>
                        <span class="n">d_fructan</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_d_fructan</span><span class="p">(</span><span class="n">conc_sucrose_hidden_growing_zone</span><span class="p">,</span> <span class="n">conc_fructan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                        <span class="c"># Synthesis proteins</span>
                        <span class="n">s_proteins</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_s_proteins</span><span class="p">(</span><span class="n">conc_amino_acids_hidden_growing_zone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                        <span class="c"># Degradation proteins</span>
                        <span class="n">conc_protein</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_conc_protein</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">proteins</span><span class="p">,</span> <span class="n">hgz</span><span class="o">.</span><span class="n">mstruct</span><span class="p">)</span>
                        <span class="n">d_proteins</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_d_proteins</span><span class="p">(</span><span class="n">conc_protein</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">element</span><span class="o">.</span><span class="n">starch</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">sucrose</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">triosesP</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;triosesP&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">fructan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">nitrates</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">amino_acids</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">proteins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">cytokinins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span>

                            <span class="c"># intermediate variables</span>
                            <span class="n">photosynthesis</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_photosynthesis</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">Ag</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">element_transpiration</span> <span class="o">=</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="c"># mmol s-1</span>

                            <span class="c"># flows</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">LaminaElement</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">is_growing</span><span class="p">:</span> <span class="c">#: Export of sucrose and amino acids towards the hidden growing zone</span>
                                <span class="n">hgz_loading_sucrose_contribution</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_export_sucrose</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">conc_sucrose_hidden_growing_zone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                                <span class="n">hgz_loading_amino_acids_contribution</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">loading_amino_acids</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_export_amino_acids</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">conc_amino_acids_hidden_growing_zone</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span> <span class="c">#: Loading of sucrose and amino acids towards the phloem</span>
                                <span class="n">hgz_loading_sucrose_contribution</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">hgz_loading_amino_acids_contribution</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">phloem_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                                <span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_loading_sucrose</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                                <span class="n">element</span><span class="o">.</span><span class="n">loading_amino_acids</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_loading_amino_acids</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                            <span class="n">s_starch</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_s_starch</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">triosesP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">d_starch</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_d_starch</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">starch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">s_sucrose</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_s_sucrose</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">triosesP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">R_phloem_loading</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_phloem</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">)</span>
                            <span class="n">regul_s_fructan</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_regul_s_fructan</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">d_fructan</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_d_fructan</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">fructan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">s_fructan</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_s_fructan</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">regul_s_fructan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">nitrates_import</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_nitrates_import</span><span class="p">(</span><span class="n">roots_uptake_nitrate</span><span class="p">,</span> <span class="n">roots_export_nitrates</span><span class="p">,</span> <span class="n">element_transpiration</span><span class="p">,</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">amino_acids_import</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_amino_acids_import</span><span class="p">(</span><span class="n">roots_export_amino_acids</span><span class="p">,</span> <span class="n">element_transpiration</span><span class="p">,</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">s_amino_acids</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_s_amino_acids</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">nitrates</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">triosesP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">R_Nnit_red</span><span class="p">,</span> <span class="n">s_amino_acids</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_red</span><span class="p">(</span><span class="n">s_amino_acids</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">)</span>
                            <span class="n">s_proteins</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_s_proteins</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">k</span><span class="p">,</span> <span class="n">d_proteins</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_d_proteins</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">proteins</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">cytokinins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                            <span class="n">cytokinins_import</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_cytokinins_import</span><span class="p">(</span><span class="n">roots_export_cytokinins</span><span class="p">,</span> <span class="n">element_transpiration</span><span class="p">,</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">d_cytokinins</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_d_cytokinins</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">cytokinins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                            <span class="c"># compartments derivatives</span>
                            <span class="n">starch_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_starch_derivative</span><span class="p">(</span><span class="n">s_starch</span><span class="p">,</span> <span class="n">d_starch</span><span class="p">)</span>
                            <span class="n">element</span><span class="o">.</span><span class="n">total_organic_nitrogen</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_total_organic_nitrogen</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">proteins</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">Nstruct</span><span class="p">)</span>
                            <span class="n">R_residual</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_residual</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">total_organic_nitrogen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">Ts</span><span class="p">)</span>
                            <span class="n">sum_respi</span> <span class="o">=</span> <span class="n">R_phloem_loading</span> <span class="o">+</span> <span class="n">R_Nnit_red</span> <span class="o">+</span> <span class="n">R_residual</span>
                            <span class="n">sucrose_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_sucrose_derivative</span><span class="p">(</span><span class="n">s_sucrose</span><span class="p">,</span> <span class="n">d_starch</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">loading_sucrose</span><span class="p">,</span> <span class="n">s_fructan</span><span class="p">,</span> <span class="n">d_fructan</span><span class="p">,</span> <span class="n">sum_respi</span><span class="p">)</span>
                            <span class="n">triosesP_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_triosesP_derivative</span><span class="p">(</span><span class="n">photosynthesis</span><span class="p">,</span> <span class="n">s_sucrose</span><span class="p">,</span> <span class="n">s_starch</span><span class="p">,</span> <span class="n">s_amino_acids</span><span class="p">)</span>
                            <span class="n">fructan_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_fructan_derivative</span><span class="p">(</span><span class="n">s_fructan</span><span class="p">,</span> <span class="n">d_fructan</span><span class="p">)</span>
                            <span class="n">nitrates_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_nitrates_derivative</span><span class="p">(</span><span class="n">nitrates_import</span><span class="p">,</span> <span class="n">s_amino_acids</span><span class="p">)</span>
                            <span class="n">amino_acids_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_amino_acids_derivative</span><span class="p">(</span><span class="n">amino_acids_import</span><span class="p">,</span> <span class="n">s_amino_acids</span><span class="p">,</span> <span class="n">s_proteins</span><span class="p">,</span> <span class="n">d_proteins</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">loading_amino_acids</span><span class="p">)</span>
                            <span class="n">proteins_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_proteins_derivative</span><span class="p">(</span><span class="n">s_proteins</span><span class="p">,</span> <span class="n">d_proteins</span><span class="p">)</span>
                            <span class="n">cytokinins_derivative</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_cytokinins_derivative</span><span class="p">(</span><span class="n">cytokinins_import</span><span class="p">,</span> <span class="n">d_cytokinins</span><span class="p">)</span>

                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">starch_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sucrose_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;triosesP&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">triosesP_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fructan_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nitrates_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">amino_acids_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">proteins_derivative</span>
                            <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cytokinins_derivative</span>

                    <span class="k">if</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># TODO: test necessaire?</span>
                        <span class="c"># compute the derivatives of the hidden growing zone</span>
                        <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_sucrose_derivative</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">unloading_sucrose</span><span class="p">,</span> <span class="n">s_fructan</span><span class="p">,</span> <span class="n">d_fructan</span><span class="p">,</span> <span class="n">hgz_loading_sucrose_contribution</span><span class="p">)</span>
                        <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_amino_acids_derivative</span><span class="p">(</span><span class="n">hgz</span><span class="o">.</span><span class="n">unloading_amino_acids</span><span class="p">,</span> <span class="n">s_proteins</span><span class="p">,</span> <span class="n">d_proteins</span><span class="p">,</span> <span class="n">hgz_loading_amino_acids_contribution</span><span class="p">)</span>
                        <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_fructan_derivative</span><span class="p">(</span><span class="n">s_fructan</span><span class="p">,</span> <span class="n">d_fructan</span><span class="p">)</span>
                        <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">hgz</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hgz</span><span class="o">.</span><span class="n">calculate_proteins_derivative</span><span class="p">(</span><span class="n">s_proteins</span><span class="p">,</span> <span class="n">d_proteins</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">phloem_contributors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">)</span>
                    <span class="c"># compute the derivative of each compartment of grains</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;structure&#39;</span><span class="p">]]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">starch</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">proteins</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>

                    <span class="c"># intermediate variables</span>
                    <span class="n">RGR_structure</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_RGR_structure</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structural_dry_mass</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_structural_dry_mass</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

                    <span class="c"># flows</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_structure</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_grain_structure</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">RGR_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_starch</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_grain_starch</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_proteins</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_proteins</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_structure</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_starch</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structural_dry_mass</span><span class="p">)</span>
                    <span class="c"># compartments derivatives</span>
                    <span class="n">R_grain_growth_struct</span><span class="p">,</span> <span class="n">R_grain_growth_starch</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_grain_growth</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_structure</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_starch</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structural_dry_mass</span><span class="p">)</span>
                    <span class="n">structure_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_structure_derivative</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_structure</span><span class="p">,</span> <span class="n">R_grain_growth_struct</span><span class="p">)</span>
                    <span class="n">starch_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_starch_derivative</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_grain_starch</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">structural_dry_mass</span><span class="p">,</span> <span class="n">R_grain_growth_starch</span><span class="p">)</span>
                    <span class="n">proteins_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_proteins_derivative</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">s_proteins</span><span class="p">)</span>
                    <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;structure&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">structure_derivative</span>
                    <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">starch_derivative</span>
                    <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">proteins_derivative</span>

                <span class="c"># compute the derivative of each compartment of soil</span>
                <span class="n">mineralisation</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">calculate_mineralisation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">soil</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">calculate_nitrates_derivative</span><span class="p">(</span><span class="n">mineralisation</span><span class="p">,</span> <span class="n">roots_uptake_nitrate</span><span class="p">)</span>

                <span class="c"># compute the derivative of each compartment of roots</span>
                <span class="n">mstruct_C_growth_tot</span><span class="p">,</span> <span class="n">Nstruct_N_growth_tot</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_mstruct_growth_cost</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct_C_growth</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">Nstruct_N_growth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                <span class="c"># flows</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_sucrose</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_unloading_sucrose</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_amino_acids</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_unloading_amino_acids</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_s_amino_acids</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">nitrates</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>
                <span class="n">R_Nnit_red</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_red</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">Roots</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">C_exudated</span><span class="p">,</span> <span class="n">N_exudated</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_exudation</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">)</span>
                <span class="n">s_cytokinins</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_s_cytokinins</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">nitrates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">)</span>

                <span class="c"># compartments derivatives</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">total_organic_nitrogen</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_total_organic_nitrogen</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">Nstruct</span><span class="p">)</span>
                <span class="n">R_residual</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_residual</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">Roots</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">total_organic_nitrogen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">soil</span><span class="o">.</span><span class="n">Tsoil</span><span class="p">)</span>
                <span class="n">R_roots_growth</span> <span class="o">=</span> <span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_growth</span><span class="p">(</span><span class="n">mstruct_C_growth_tot</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="p">)</span>
                <span class="n">sum_respi</span> <span class="o">=</span> <span class="n">R_Nnit_upt</span> <span class="o">+</span> <span class="n">R_Nnit_red</span> <span class="o">+</span> <span class="n">R_residual</span> <span class="o">+</span> <span class="n">R_roots_growth</span>
                <span class="n">sucrose_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_sucrose_derivative</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_sucrose</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span><span class="p">,</span> <span class="n">mstruct_C_growth_tot</span><span class="p">,</span> <span class="n">C_exudated</span><span class="p">,</span> <span class="n">sum_respi</span><span class="p">)</span>
                <span class="n">nitrates_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_nitrates_derivative</span><span class="p">(</span><span class="n">roots_uptake_nitrate</span><span class="p">,</span> <span class="n">roots_export_nitrates</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span><span class="p">)</span>
                <span class="n">amino_acids_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_amino_acids_derivative</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">unloading_amino_acids</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">s_amino_acids</span><span class="p">,</span> <span class="n">roots_export_amino_acids</span><span class="p">,</span> <span class="n">Nstruct_N_growth_tot</span><span class="p">,</span> <span class="n">N_exudated</span><span class="p">)</span>
                <span class="n">cytokinins_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_cytokinins_derivative</span><span class="p">(</span><span class="n">s_cytokinins</span><span class="p">,</span> <span class="n">roots_export_cytokinins</span><span class="p">)</span>

                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sucrose_derivative</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nitrates_derivative</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">amino_acids_derivative</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cytokinins_derivative</span>

                <span class="c"># compute the derivative of each compartment of phloem</span>
                <span class="n">sucrose_phloem_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_sucrose_derivative</span><span class="p">(</span><span class="n">phloem_contributors</span><span class="p">)</span>
                <span class="n">amino_acids_phloem_derivative</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_amino_acids_derivative</span><span class="p">(</span><span class="n">phloem_contributors</span><span class="p">)</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sucrose_phloem_derivative</span>
                <span class="n">y_derivatives</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">amino_acids_phloem_derivative</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progressbar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progressbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">derivatives_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;cnwheat.derivatives&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">derivatives_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_compartments</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y_derivatives</span><span class="p">,</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">LOGGERS_NAMES</span><span class="p">[</span><span class="s">&#39;derivatives&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">y_derivatives</span>


    <span class="k">def</span> <span class="nf">_update_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartments_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the state of :attr:`population` and :attr:`soils` from the values in `compartments_values`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Updating the state of the population and soils...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model_object</span><span class="p">,</span> <span class="n">compartments</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="n">compartment_index</span> <span class="ow">in</span> <span class="n">compartments</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model_object</span><span class="p">,</span> <span class="n">compartment_name</span><span class="p">,</span> <span class="n">compartments_values</span><span class="p">[</span><span class="n">compartment_index</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Updating the state of the population and soils DONE&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Simulation.postprocessings"><a class="viewcode-back" href="../../ref.html#cnwheat.simulation.Simulation.postprocessings">[docs]</a>    <span class="k">def</span> <span class="nf">postprocessings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c">#TODO: update doc</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute:</span>

<span class="sd">            * intermediate variables (see :attr:`Simulation:PLANTS_INTERMEDIATE_VARIABLES`, :attr:`Simulation:AXES_INTERMEDIATE_VARIABLES`, :attr:`Simulation:PHYTOMERS_INTERMEDIATE_VARIABLES`, :attr:`Simulation:ORGANS_INTERMEDIATE_VARIABLES`, :attr:`Simulation:ELEMENTS_INTERMEDIATE_VARIABLES` and :attr:`Simulation:SOILS_INTERMEDIATE_VARIABLES`),</span>
<span class="sd">            * fluxes (see :attr:`Simulation:PLANTS_FLUXES`, :attr:`Simulation:AXES_FLUXES`, :attr:`Simulation:PHYTOMERS_FLUXES`, :attr:`Simulation:ORGANS_FLUXES`, :attr:`Simulation:ELEMENTS_FLUXES` and :attr:`Simulation:SOILS_FLUXES`),</span>
<span class="sd">            * and integrative variables (see :attr:`Simulation:PLANTS_INTEGRATIVE_VARIABLES`, :attr:`Simulation:AXES_INTEGRATIVE_VARIABLES`, :attr:`Simulation:PHYTOMERS_INTEGRATIVE_VARIABLES`, :attr:`Simulation:ORGANS_INTEGRATIVE_VARIABLES`, :attr:`Simulation:ELEMENTS_INTEGRATIVE_VARIABLES` and :attr:`Simulation:SOILS_INTEGRATIVE_VARIABLES`),</span>

<span class="sd">        from :attr:`_solver_output` and format them to :class:`dataframes &lt;pandas.DataFrame&gt;`.</span>

<span class="sd">        :Returns:</span>
<span class="sd">            :class:`dataframes &lt;pandas.DataFrame&gt;` of post-processing outputs at each scale:</span>

<span class="sd">                * plant (see :attr:`Simulation:PLANTS_ALL_VARIABLES`)</span>
<span class="sd">                * axis (see :attr:`Simulation:AXES_ALL_VARIABLES`)</span>
<span class="sd">                * metamer (see :attr:`Simulation:PHYTOMERS_ALL_VARIABLES`)</span>
<span class="sd">                * organ (see :attr:`Simulation:ORGANS_ALL_VARIABLES`)</span>
<span class="sd">                * element (see :attr:`Simulation:ELEMENTS_ALL_VARIABLES`)</span>
<span class="sd">                * and soil (see :attr:`Simulation:SOILS_ALL_VARIABLES`)</span>

<span class="sd">        :Returns Type:</span>
<span class="sd">            :class:`tuple` of :class:`pandas.DataFrame`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Formatting of outputs...&#39;</span><span class="p">)</span>

        <span class="n">solver_output_transposed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solver_output</span><span class="o">.</span><span class="n">T</span>

        <span class="n">all_plants_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PLANTS_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_axes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">AXES_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_metamers_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PHYTOMERS_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">HIDDENGROWINGZONE_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ORGANS_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_elements_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ELEMENTS_ALL_VARIABLES</span><span class="p">)</span>
        <span class="n">all_soils_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">SOILS_ALL_VARIABLES</span><span class="p">)</span>

        <span class="n">delta_t_repeated</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">plants</span><span class="p">:</span>

            <span class="n">plants_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_plants_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">plants_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
            <span class="n">plants_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>

            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">plant</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>

                <span class="n">axes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_axes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">axes_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                <span class="n">axes_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                <span class="n">axes_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>

                <span class="c"># compute the total transpiration</span>
                <span class="n">total_transpiration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)</span>
                <span class="n">total_green_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)</span>
                <span class="n">transpiration_mapping</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_total_transpiration</span><span class="p">,</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">Tr</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">green_area</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">))</span>
                                    <span class="n">total_transpiration</span> <span class="o">+=</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
                                    <span class="n">total_green_area</span> <span class="o">+=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">green_area</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)</span>
                <span class="n">total_surfacic_transpiration</span> <span class="o">=</span> <span class="n">total_transpiration</span> <span class="o">/</span> <span class="n">total_green_area</span>

                <span class="n">axes_df</span><span class="p">[</span><span class="s">&#39;Total_transpiration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_transpiration</span>

                <span class="c"># format phloem outputs</span>
                <span class="n">organs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_organs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;organ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">label</span>
                <span class="n">phloem_sucrose</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phloem_sucrose</span>
                <span class="n">phloem_amino_acids</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phloem_amino_acids</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_conc_sucrose</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">phloem</span><span class="o">.</span><span class="n">calculate_conc_amino_acids</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">])</span>
                <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">organs_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># format soil output</span>
                <span class="n">soils_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_soils_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                <span class="n">soil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">soils</span><span class="p">[(</span><span class="n">plant</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span><span class="p">)]</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">volume</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">soil</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;Tsoil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">Tsoil</span>
                <span class="n">conc_nitrates_soil</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">soil</span><span class="o">.</span><span class="n">calculate_conc_nitrates</span><span class="p">,</span> <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">])</span>
                <span class="n">soils_df</span><span class="p">[</span><span class="s">&#39;Conc_Nitrates_Soil&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conc_nitrates_soil</span>
                <span class="n">all_soils_df</span> <span class="o">=</span> <span class="n">all_soils_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">soils_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># format roots outputs</span>
                <span class="n">organs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_organs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;organ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">label</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;mstruct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Nstruct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">Nstruct</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_conc_sucrose</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_Nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_conc_nitrates</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_conc_amino_acids</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Unloading_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_unloading_sucrose</span><span class="p">,</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Unloading_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_unloading_amino_acids</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Unloading_Sucrose&#39;</span><span class="p">],</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">phloem_amino_acids</span><span class="p">)</span>
                <span class="n">uptake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_uptake_nitrates</span><span class="p">,</span> <span class="n">conc_nitrates_soil</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">))</span>
                <span class="n">roots_uptake_nitrates</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;HATS_LATS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uptake</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">uptake</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Uptake_Nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roots_uptake_nitrates</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;regul_transpiration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_regul_transpiration</span><span class="p">(</span><span class="n">axes_df</span><span class="p">[</span><span class="s">&#39;Total_transpiration&#39;</span><span class="p">])</span>
                <span class="n">roots_export_nitrates</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_nitrates</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;regul_transpiration&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Export_Nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roots_export_nitrates</span>
                <span class="n">roots_export_amino_acids</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_amino_acids</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;regul_transpiration&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Export_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roots_export_amino_acids</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_s_amino_acids</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_Nnit_upt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_upt</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Uptake_Nitrates&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">])</span>
                <span class="n">output_respi_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_red</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="p">[</span><span class="bp">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_Nnit_red&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">total_organic_nitrogen</span> <span class="o">=</span>  <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_total_organic_nitrogen</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">Nstruct</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">))</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;total_organic_nitrogen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_organic_nitrogen</span>
                <span class="n">R_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_residual</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="n">total_organic_nitrogen</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="p">[</span><span class="n">soil</span><span class="o">.</span><span class="n">Tsoil</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_residual&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_maintenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_residual</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">R_residual</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mstruct_growth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_mstruct_growth_cost</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;mstruct_C_growth&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Nstruct_N_growth&#39;</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                <span class="n">mstruct_C_growth_tot</span><span class="p">,</span> <span class="n">Nstruct_N_growth_tot</span> <span class="o">=</span> <span class="n">mstruct_growth</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">mstruct_growth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_growth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_growth</span><span class="p">,</span> <span class="n">mstruct_C_growth_tot</span><span class="p">,</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">))</span>
                <span class="n">exudation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_exudation</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Unloading_Sucrose&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="n">phloem_amino_acids</span><span class="p">))</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;C_exudation&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;N_exudation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exudation</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">exudation</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Conc_cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_conc_cytokinins</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_s_cytokinins</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">root_export_cytokinins</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">calculate_export_cytokinins</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;regul_transpiration&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Export_cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_export_cytokinins</span>

                <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">organs_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># format photosynthetic organs elements outputs</span>
                <span class="k">for</span> <span class="n">phytomer</span> <span class="ow">in</span> <span class="n">axis</span><span class="o">.</span><span class="n">phytomers</span><span class="p">:</span>
                    <span class="n">metamers_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_metamers_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">metamers_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                    <span class="n">metamers_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">metamers_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                    <span class="n">metamers_df</span><span class="p">[</span><span class="s">&#39;metamer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">index</span>

                    <span class="c"># Hidden growing zones</span>
                    <span class="k">if</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">hgzs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;metamer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;mstruct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">][</span><span class="s">&#39;mstruct&#39;</span><span class="p">]]</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>
                        <span class="n">hgzs_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">phytomer</span><span class="o">.</span><span class="n">hiddengrowingzone</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>

                        <span class="n">all_hgzs_df</span> <span class="o">=</span> <span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hgzs_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">organ</span> <span class="ow">in</span> <span class="p">(</span><span class="n">phytomer</span><span class="o">.</span><span class="n">chaff</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">peduncle</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">lamina</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">internode</span><span class="p">,</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">sheath</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">organ</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">(</span><span class="n">organ</span><span class="o">.</span><span class="n">exposed_element</span><span class="p">,</span> <span class="n">organ</span><span class="o">.</span><span class="n">enclosed_element</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">elements_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_elements_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;metamer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phytomer</span><span class="o">.</span><span class="n">index</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;organ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">organ</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;green_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">green_area</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;mstruct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">mstruct</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Nstruct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">Nstruct</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;triosesP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;triosesP&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;sucrose&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;fructan&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;nitrates&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;amino_acids&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Loading_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_loading_sucrose</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">output_respi_model</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_phloem</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Loading_Sucrose&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;R_phloem_loading&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Loading_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Regul_S_Fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_regul_s_fructan</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Loading_Sucrose&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Ag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">Ag</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_s_amino_acids</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;triosesP&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">output_respi_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_Nnit_red</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;R_Nnit_red&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_respi_model</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">total_organic_nitrogen</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_total_organic_nitrogen</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">Nstruct</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">))</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;total_organic_nitrogen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_organic_nitrogen</span>
                            <span class="n">R_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_residual</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">mstruct</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="o">.</span><span class="n">ALPHA</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="n">total_organic_nitrogen</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">Ts</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">)))</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;R_residual&#39;</span><span class="p">],</span>  <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;R_maintenance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_residual</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">R_residual</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Tr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">Tr</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">Ts</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;is_growing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">is_growing</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Photosynthesis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_photosynthesis</span><span class="p">,</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">Ag</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">green_area</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">),</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Transpiration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_TriosesP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_triosesP</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;triosesP&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_starch</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;starch&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_sucrose</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_fructan</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;fructan&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Nitrates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_nitrates</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;nitrates&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_amino_acids</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_Proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_proteins</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">])</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_s_starch</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;triosesP&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;D_Starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_d_starch</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;starch&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Sucrose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_s_sucrose</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;triosesP&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_s_fructan</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Regul_S_Fructan&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;D_Fructan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_d_fructan</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;sucrose&#39;</span><span class="p">],</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;fructan&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Nitrates_import&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_nitrates_import</span><span class="p">,</span> <span class="n">roots_uptake_nitrates</span><span class="p">,</span> <span class="n">roots_export_nitrates</span><span class="p">,</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">],</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Amino_Acids_import&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_amino_acids_import</span><span class="p">,</span> <span class="n">roots_export_amino_acids</span><span class="p">,</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">],</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;S_Proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_s_proteins</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">d_proteins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_d_proteins</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">],</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]],</span> <span class="n">delta_t_repeated</span><span class="p">))</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;k_proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_proteins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;D_Proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_proteins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Loading_Amino_Acids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_loading_amino_acids</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;amino_acids&#39;</span><span class="p">],</span> <span class="n">phloem_amino_acids</span><span class="p">,</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="s">&#39;cytokinins&#39;</span><span class="p">]]</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;cytokinins_import&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_cytokinins_import</span><span class="p">,</span> <span class="n">root_export_cytokinins</span><span class="p">,</span> <span class="n">transpiration_mapping</span><span class="p">[</span><span class="n">element</span><span class="p">],</span> <span class="n">total_transpiration</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;D_cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">calculate_d_cytokinins</span><span class="p">,</span> <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                            <span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;Conc_cytokinins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">calculate_conc_cytokinins</span><span class="p">(</span><span class="n">elements_df</span><span class="p">[</span><span class="s">&#39;cytokinins&#39;</span><span class="p">])</span>

                            <span class="n">all_elements_df</span> <span class="o">=</span> <span class="n">all_elements_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                    <span class="n">all_metamers_df</span> <span class="o">=</span> <span class="n">all_metamers_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metamers_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="c"># format grains outputs</span>
                <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">organs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_organs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant</span><span class="o">.</span><span class="n">index</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">label</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;organ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">label</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;structure&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;starch&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver_output_transposed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions_mapping</span><span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="p">][</span><span class="s">&#39;proteins&#39;</span><span class="p">]]</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;RGR_Structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_RGR_structure</span><span class="p">,</span> <span class="n">phloem_sucrose</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_grain_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;structure&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;RGR_Structure&#39;</span><span class="p">],</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">structural_dry_mass</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_structural_dry_mass</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;structure&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_starch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_grain_starch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_grid</span><span class="p">,</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">delta_t_repeated</span><span class="p">)</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Dry_Mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_dry_mass</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;structure&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;starch&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;Proteins_N_Mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_protein_N_mass</span><span class="p">(</span><span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;proteins&#39;</span><span class="p">])</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_Proteins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">grains</span><span class="o">.</span><span class="n">calculate_s_proteins</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_structure&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_starch&#39;</span><span class="p">],</span> <span class="n">phloem_amino_acids</span><span class="p">,</span> <span class="n">phloem_sucrose</span><span class="p">,</span> <span class="n">structural_dry_mass</span><span class="p">)</span>
                <span class="n">R_grain_growth</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">RespirationModel</span><span class="o">.</span><span class="n">R_grain_growth</span><span class="p">,</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_structure&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;S_grain_starch&#39;</span><span class="p">],</span> <span class="n">structural_dry_mass</span><span class="p">))</span>
                <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_grain_growth_struct&#39;</span><span class="p">],</span> <span class="n">organs_df</span><span class="p">[</span><span class="s">&#39;R_grain_growth_starch&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">R_grain_growth</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">R_grain_growth</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">organs_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">all_axes_df</span> <span class="o">=</span> <span class="n">all_axes_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">all_plants_df</span> <span class="o">=</span> <span class="n">all_plants_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plants_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># set the order of the columns</span>
        <span class="n">all_plants_df</span> <span class="o">=</span> <span class="n">all_plants_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PLANTS_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_axes_df</span> <span class="o">=</span> <span class="n">all_axes_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">AXES_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_metamers_df</span> <span class="o">=</span> <span class="n">all_metamers_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PHYTOMERS_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span> <span class="o">=</span> <span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">HIDDENGROWINGZONE_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ORGANS_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_elements_df</span> <span class="o">=</span> <span class="n">all_elements_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ELEMENTS_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_soils_df</span> <span class="o">=</span> <span class="n">all_soils_df</span><span class="o">.</span><span class="n">reindex_axis</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">SOILS_ALL_VARIABLES</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># sort the rows by the columns</span>
        <span class="n">all_plants_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PLANTS_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_axes_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">AXES_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_metamers_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">PHYTOMERS_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">HIDDENGROWINGZONE_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_organs_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ORGANS_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_elements_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">ELEMENTS_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_soils_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">Simulation</span><span class="o">.</span><span class="n">SOILS_OUTPUTS_INDEXES</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># infer the right types of the columns</span>
        <span class="n">all_plants_df</span> <span class="o">=</span> <span class="n">all_plants_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_axes_df</span> <span class="o">=</span> <span class="n">all_axes_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_metamers_df</span> <span class="o">=</span> <span class="n">all_metamers_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span> <span class="o">=</span> <span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_organs_df</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_elements_df</span> <span class="o">=</span> <span class="n">all_elements_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">all_soils_df</span> <span class="o">=</span> <span class="n">all_soils_df</span><span class="o">.</span><span class="n">convert_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># convert the indexes of plants and metamers to integers</span>
        <span class="n">all_plants_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_plants_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_axes_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_axes_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_metamers_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">all_metamers_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">all_hgzs_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_organs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_organs_df</span><span class="p">[</span><span class="s">&#39;plant&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_elements_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">all_elements_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">,</span> <span class="s">&#39;metamer&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">all_soils_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">all_soils_df</span><span class="p">[[</span><span class="s">&#39;plant&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">all_plants_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_axes_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_metamers_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_hgzs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_organs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_elements_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">all_soils_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Formatting of outputs DONE&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_plants_df</span><span class="p">,</span> <span class="n">all_axes_df</span><span class="p">,</span> <span class="n">all_metamers_df</span><span class="p">,</span> <span class="n">all_organs_df</span><span class="p">,</span> <span class="n">all_hgzs_df</span><span class="p">,</span> <span class="n">all_elements_df</span><span class="p">,</span> <span class="n">all_soils_df</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">CN-Wheat 0.0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, C.Chambon and R.Barillot.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>